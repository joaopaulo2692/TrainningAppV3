@using MudBlazor
@using TrainningApp.Core.DTO.Exercise
@using TrainningApp.Core.DTO.Muscle
@using TrainningApp.Core.DTO.TrainningExercise
@using TrainningAppV3.Client.Components


<MudDialog MaxWidth="MaxWidth.ExtraLarge" FullWidth="true" Class="custom-dialog rounded-lg">
    <DialogContent>
        @if (set > 4) {
            dialogScreen = "620px";
        }

        @if (!musclesList.Select(x => x.Name).Contains(muscleSelected))
        {
            exerciseList = exerciseListCopy;
        }
        <div class="d-flex flex-column py-1" style="min-height: @dialogScreen;">
            <MudAutocomplete T="string" Label="Filtro por músculo" @bind-Value="muscleSelected" SearchFunc="@SearchByMuscle"
                             ResetValueOnEmptyText="@resetValueOnEmptyText"
                             CoerceText="@coerceText" CoerceValue="@coerceValue" />

            @if (exerciseList.Where(x => x.Name == exerciseSelected).FirstOrDefault() != null)
            {
                if (exerciseList[0].Video == null) exerciseNotHasVideo = true;
                else if (exerciseList[0].Video == "") exerciseNotHasVideo = true;
                else if (exerciseList[0].Video != null && exerciseList[0].Video != "") exerciseNotHasVideo = false;
            }
            <MudAutocomplete T="string" Label="Exercício" @bind-Value="exerciseSelected" SearchFunc="@SearchExercise"           
                             ResetValueOnEmptyText="@resetValueOnEmptyText"
                             CoerceText="@coerceText" CoerceValue="@coerceValue" />

            <MudNumericField Label="Intervalo entre séries (seg)"
                             @bind-Value="rest"
                             Max="9"
                             Min="0"
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             Style="width: 80px; height: 40px; padding-top: 6px;" />


            <div class="d-flex flex-row align-items-center">
                <MudNumericField Label="Série" @bind-Value="set" Max="9" Min="0" Variant="Variant.Outlined" Style="width: 80px; height: 30px;" />
                <MudTextField Label="Repetições" @bind-Value="reps[0]" />
                <MudNumericField Label="Série"
                                 @bind-Value="set"
                                 Max="9"
                                 Min="0"
                                 Variant="Variant.Outlined"
                                 Style="width: 80px; height: 30px;"
                                 Class="invisible" />
                <MudTextField Label="Carga" @bind-Value="weights[0]" />
            </div>

            @for (int i = 1; i < set; i++)
            {
                
                 <ExerciseInput Index="i"
                  Reps="reps"
                  Weights="weights"
                  OnRepSave="OnRepSave"
                  OnWeightSave="OnWeightSave" />
                  

               @*  <div class="d-flex flex-row align-items-center">
                    <MudNumericField Label="Série"
                                     @bind-Value="set"
                                     Max="9"
                                     Min="0"
                                     Variant="Variant.Outlined"
                                     Style="width: 80px; height: 30px;"
                                     Class="invisible" />

                    @* <MudTextField Label="" Value="@(reps[i])" @oninput="(e => OnRepsChanged(e, i))" /> *@
               @*      <MudTextField Label="" @bind-Value="reps[i]"
                                  @onblur="(e => OnRepSave(reps[i], i))" />" />

                    <MudNumericField Label="Série"
                                     @bind-Value="set"
                                     Max="9"
                                     Min="0"
                                     Variant="Variant.Outlined"
                                     Style="width: 80px; height: 30px;"
                                     Class="invisible" />


                    @* <MudTextField Label="" @bind-Value="weights[i]" /> *@
                @*     <MudTextField Label="Peso"
                                  @bind-Value="weights[i]"
                                  @onblur="(e => OnWeightSave(weights[i], i))" />
                </div> *@ *@ *@
            }
            <MudTextField Label="Observação" @bind-Value="observation" />
            <MudTooltip Text="Este exercício não possui Video" Disabled="@ShowTooltip">
            <MudButton OnClick="OpenVideo" Variant="Variant.Filled" Disabled="exerciseNotHasVideo" Color="Color.Secondary" Style="margin-right: 20px;">Visualizar Exercício</MudButton>
            </MudTooltip>
            @if(videoOn == true)
            {
                <div class="d-flex justify-content-center align-items-center mt-3">
                    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; width: 640px;">
                        <iframe src="@exerciseList.FirstOrDefault().Video"
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                                frameborder="0"
                                allowfullscreen>
                        </iframe>
                    </div>
                </div>
            }
            
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Filled" OnClick="AddNewExercise" Color="Color.Success">Adicionar</MudButton>

        <MudButton Color="Color.Primary" OnClick="Close">Fechar</MudButton>
    </DialogActions>
</MudDialog>

<style>
    .custom-dialog {
        max-width: 800px;
        margin: 20px auto; /* Adiciona 20px de margem superior e inferior e centraliza horizontalmente */
        width: 90%; /* Ajusta a largura para 100% menos as margens laterais *
    }
</style>

@code {
    private void OnWeightSave(string valor, int index)
    {
        index -= 2;
        // Converte e armazena o valor no índice correspondente
        weights[index] = valor;
    }
    private void OnRepSave(string valor, int index)
    {
        index -= 2;
        // Converte e armazena o valor no índice correspondente
        reps[index] = valor;
    }

    // private void OnRepsChanged(ChangeEventArgs e, int index)
    // {

    //     reps[index] = e.Value.ToString();

    //     StateHasChanged();

    // }
    private void UpdateWeights(ChangeEventArgs e, int index)
    {

        weights[index] = e.Value?.ToString() ?? "";

    }
    private void OnRepsChanged(ChangeEventArgs e, int index)
    {
        index -= 2;
        if (index >= 0 && index < reps.Count)
        {
            reps[index] = e.Value.ToString();
        }
        StateHasChanged();
    }

    // private void OnWeightsChanged(string newValue, int index)
    // {
    //     weights[index] = newValue;
    //     StateHasChanged();
       
    // }

    public TrainningExerciseVO trainningExerciseVO;


    [Parameter]
    public EventCallback<TrainningExerciseVO> OnAddExercise { get; set; }

    private string[] array = new string[5];
    private int rest;
    private bool ShowTooltip => !exerciseNotHasVideo;
    private bool videoOn = false;
    private bool exerciseNotHasVideo = true;
    private string dialogScreen = "420px";
    private bool resetValueOnEmptyText;
    private bool coerceText;
    private bool coerceValue;
    private string exerciseSelected; // Corrigido: adicione o ponto e vírgula
    private string muscleSelected;
    private int set = 1;
    private string observation;
    private List<string> reps = new List<string> { "", "", "", "", "" };
    private string[] weights = new string[10];
    // private List<string> weights = new List<string> { "", "", "", "", "" };
    ExerciseReturnVO exerciseVO = new ExerciseReturnVO();
    MuscleVO muscleVO = new MuscleVO();

    [CascadingParameter] MudDialogInstance MudDialog { get; set; }

    private void Close() => MudDialog.Close(DialogResult.Ok(true));

    private void OpenVideo()
    {
        videoOn = true;
        ExerciseReturnVO exerciseVO = exerciseList.FirstOrDefault();
        StateHasChanged();
    }

    private async Task AddNewExercise()
    {

        trainningExerciseVO = new TrainningExerciseVO
            {
                ExerciseName = exerciseSelected,
                Reps = string.Join("/", reps),
                // Reps = array[1],
                Interval = rest,
                Weight = string.Join("/", weights),
                Info = observation,
                Set = set
           
            };

        // Chame o EventCallback passando o trainningExercise
        await OnAddExercise.InvokeAsync(trainningExerciseVO);
            
        // Feche o diálogo
        // MudDialog.Close();
        MudDialog.Close(DialogResult.Ok(trainningExerciseVO));
    }

    private async Task<IEnumerable<string>> SearchExercise(string value, CancellationToken token)
    {
        exerciseList = exerciseListCopy;
        await Task.Delay(5, token); // Simulação de chamada assíncrona
        StateHasChanged();
        MuscleVO muscleVO = musclesList.Where(x => x.Name == muscleSelected).FirstOrDefault();


        if (muscleVO != null) exerciseList = exerciseList.Where(x => x.Muscles.Contains(muscleVO.Name)).ToList();
        if (string.IsNullOrEmpty(value))
            return exerciseList.Select(x => x.Name);
        ExerciseReturnVO exerciseVO = exerciseList.Where(x => x.Name == value).FirstOrDefault();
        if (exerciseVO != null)
        {
            if (exerciseVO.Video == null) exerciseNotHasVideo = true;
            else if (exerciseVO.Video == "") exerciseNotHasVideo = true;
            else if (exerciseVO.Video != null && exerciseVO.Video != "") exerciseNotHasVideo = false;

        }
        StateHasChanged();

        return exerciseList.Select(x => x.Name).Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private async Task<IEnumerable<string>> SearchByMuscle(string value, CancellationToken token)
    {
        await Task.Delay(5, token); // Simulação de chamada assíncrona
        if (string.IsNullOrEmpty(value))
        {
            muscleSelected = string.Empty;
            exerciseList = exerciseListCopy.ToList();
            return musclesList.Select(x => x.Name);
        }     
        
     

        if (musclesList.Select(x => x.Name).Where(x => x == value).ToList() == null)
        {
            exerciseList = exerciseListCopy;
        }
        return musclesList.Select(x => x.Name).Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }
    protected override void OnParametersSet()
    {
        var selectedMuscle = musclesList.FirstOrDefault(x => x.Name == muscleSelected);
        if (selectedMuscle != null)
        {
            exerciseList = exerciseList.Where(x => x.Muscles.Contains(selectedMuscle.Name)).ToList();
        }
    }

    List<ExerciseReturnVO> exerciseList = new List<ExerciseReturnVO>
    {
        new ExerciseReturnVO { Id = 1, Name = "Supino reto", Muscles = new List<string>{"Peito" },Video = "https://www.youtube.com/embed/dQw4w9WgXcQ"  },
        new ExerciseReturnVO { Id = 2, Name = "Tríceps testa" ,Muscles = new List<string>{"Tríceps" } },
        new ExerciseReturnVO { Id = 3, Name = "Rosca" ,Muscles = new List<string>{"Bíceps" } }
    };

    List<ExerciseReturnVO> exerciseListCopy = new List<ExerciseReturnVO>
    {
        new ExerciseReturnVO { Id = 1, Name = "Supino reto", Muscles = new List<string>{"Peito" }, Video = "https://www.youtube.com/embed/dQw4w9WgXcQ" },
        new ExerciseReturnVO { Id = 2, Name = "Tríceps testa" ,Muscles = new List<string>{"Tríceps" } },
        new ExerciseReturnVO { Id = 3, Name = "Rosca" ,Muscles = new List<string>{"Bíceps" } }
    };

    List<MuscleVO> musclesList = new List<MuscleVO>
    {
        new MuscleVO{Id = 1, Name ="Peito",exerciseIds=new List<int>(){1} },
        new MuscleVO{Id = 2, Name ="Tríceps",exerciseIds=new List<int>(){2} },
        new MuscleVO{Id = 3, Name ="Bíceps",exerciseIds=new List<int>(){3} },
    };
}
